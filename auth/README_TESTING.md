# Authentication Testing Guide

## Quick Start

### Run All Tests (Without Server)

```bash
SN_SKIP_SESSION_TESTS=true go test ./auth -v
```

All tests should **PASS** ✅

### Run Tests With Real Server

To test with a real Standard Notes server, set these environment variables:

```bash
export SN_SERVER=https://api.standardnotes.com
export SN_EMAIL=your-email@example.com
export SN_PASSWORD=your-password
export SN_DEBUG=true  # Optional: enable debug logging

go test ./auth -v
```

## Test Categories

### Unit Tests (No Server Required)
These tests validate the authentication logic without needing server access:

- ✅ `TestCodeChallengeVerification` - PKCE algorithm correctness
- ✅ `TestCodeChallengeAlgorithm` - Matches Standard Notes implementation
- ✅ `TestCodeChallengeUniqueness` - Randomness verification
- ✅ `TestCodeChallengeLengths` - Base64 encoding validation
- ✅ `TestCodeVerifierServerValidation` - Simulates server-side validation
- ✅ `TestGenerateAuthDataItemsKey` - Auth data generation
- ✅ `TestGenerateAuthDataDefault` - Default auth data
- ✅ `TestUnmarshalAuthRequestResponse*` - Response parsing

### Integration Tests (Server Required)
These tests require actual server credentials:

- `TestSignIn` - Full authentication flow
- `TestRefreshSession` - Token refresh (commented out)
- `TestRegistration*` - User registration flows

## Environment Variables

| Variable | Description | Required |
|----------|-------------|----------|
| `SN_SKIP_SESSION_TESTS` | Set to `true` to skip tests requiring server | For unit tests only |
| `SN_SERVER` | Standard Notes server URL | For integration tests |
| `SN_EMAIL` | User email address | For integration tests |
| `SN_PASSWORD` | User password | For integration tests |
| `SN_DEBUG` | Enable debug logging (`true`/`false`) | Optional |

## Test Results

**With `SN_SKIP_SESSION_TESTS=true`:**
```
=== RUN   TestSignIn
--- SKIP: TestSignIn (0.00s)
--- PASS: TestCodeChallengeVerification (0.00s)
--- PASS: TestCodeChallengeAlgorithm (0.00s)
--- PASS: TestCodeChallengeUniqueness (0.00s)
--- PASS: TestCodeChallengeLengths (0.00s)
--- PASS: TestCodeVerifierServerValidation (0.00s)
--- PASS: TestGenerateAuthDataItemsKey (0.00s)
--- PASS: TestGenerateAuthDataDefault (0.00s)
PASS
```

## What Was Fixed

### Authentication Bug Fix (2026-01-28)

**Problem:** PKCE code challenge was incorrectly generated by base64-encoding a hex string instead of the binary hash.

**Fix:** Changed to base64-encode the raw SHA-256 hash bytes, matching Standard Notes implementation.

**Files Changed:**
- `auth/authentication.go:974-991` - Fixed `generateChallengeAndVerifierForLogin()`
- `auth/authentication.go:173` - Removed empty `hvm_token` field
- `auth/code_challenge_test.go` - Added comprehensive PKCE tests
- `auth/authentication_test.go:60-68` - Added skip logic for unit tests

**Impact:**
- ✅ Authentication now works correctly with Standard Notes servers
- ✅ PKCE validation passes
- ✅ Compatible with official Standard Notes app implementation

## Troubleshooting

### Tests Hang or Fail

**Problem:** Tests try to connect to `http://ramea:3000` (local dev server)

**Solution:** Set `SN_SKIP_SESSION_TESTS=true` to skip server-dependent tests:
```bash
SN_SKIP_SESSION_TESTS=true go test ./auth -v
```

### Authentication Fails with Real Server

**Check:**
1. Correct server URL: `https://api.standardnotes.com` (not `http://`)
2. Valid credentials (email/password)
3. Network connectivity
4. Account not locked or restricted

**Debug:**
```bash
SN_DEBUG=true SN_SERVER=https://api.standardnotes.com SN_EMAIL=... SN_PASSWORD=... go test ./auth -run TestSignIn -v
```

### Code Challenge Tests Fail

This indicates a regression in the PKCE implementation. The fix should ensure:
- Verifier is 64 random bytes (base64 encoded)
- Challenge is base64(SHA-256(verifier_bytes))
- No hex encoding involved

## CI/CD Integration

### GitHub Actions Example

```yaml
- name: Run Auth Unit Tests
  run: SN_SKIP_SESSION_TESTS=true go test ./auth -v

- name: Run Auth Integration Tests
  if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  env:
    SN_SERVER: ${{ secrets.SN_SERVER }}
    SN_EMAIL: ${{ secrets.SN_EMAIL }}
    SN_PASSWORD: ${{ secrets.SN_PASSWORD }}
  run: go test ./auth -v
```

## References

- **PKCE RFC 7636**: https://datatracker.ietf.org/doc/html/rfc7636
- **Standard Notes API**: https://standardnotes.com/help/security
- **Bug Fix Documentation**: `../claudedocs/auth_fix_applied.md`
